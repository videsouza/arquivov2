<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Boxes | Hub de Servi√ßos</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Vari√°veis de Cor Minimalistas */
        :root {
            --primary-color: #f7931e; /* Laranja/Ambar */
            --primary-dark: #cc7815;
            --secondary-color: #1f2937; /* Cinza Escuro para texto */
            --text-light: #6b7280;
            --bg-light: #f9f9f9;
            --bg-white: #ffffff;
            --border-color: #e5e7eb;
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.05);
            --success-color: #10b981; /* Verde (Ocupado) */
            --danger-color: #ef4444; /* Vermelho (Livre/Vazio) */
        }

        /* --- ESTILOS GERAIS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            padding: 30px;
            min-height: 100vh;
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: var(--shadow-subtle);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 800px;
            border: 1px solid var(--border-color);
        }

        /* --- HEADER CLEAN --- */
        .header {
            background: var(--bg-white); /* Fundo branco ou levemente cinza */
            color: var(--secondary-color);
            padding: 30px 40px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 { 
            font-size: 28px; 
            margin-bottom: 5px; 
            font-weight: 800;
            color: var(--secondary-color);
        }
        .header h1 i { color: var(--primary-color); margin-right: 10px; }
        .header p { opacity: 0.8; font-size: 15px; color: var(--text-light); }

        .content { padding: 40px; }

        /* --- UPLOAD --- */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--bg-white);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }
        .upload-area:hover { border-color: var(--primary-color); background: #fffbf5; transform: translateY(-2px); }
        .upload-icon { font-size: 40px; color: var(--primary-color); margin-bottom: 15px; }
        .upload-area h3 { color: var(--secondary-color); font-size: 20px; margin-bottom: 10px; }

        /* --- DASHBOARD --- */
        #results { display: none; animation: fadeIn 0.5s; }

        /* 1. ESTAT√çSTICAS GERAIS (TOPO) - CLEAN KPIs */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-subtle);
            text-align: left;
            transition: border-color 0.2s;
        }
        .stat-card:hover { border-color: var(--primary-color); }

        .stat-value { font-size: 32px; font-weight: 800; color: var(--secondary-color); line-height: 1; }
        .stat-sub { font-size: 14px; color: var(--text-light); font-weight: 600; margin-top: 5px; }
        .stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-light); font-weight: 700; margin-top: 10px; opacity: 0.7; }

        /* Cores de status nos KPIs */
        #valOcupados { color: var(--success-color); }
        #valVazios { color: var(--danger-color); }
        #valDocs { color: var(--primary-color); }

        /* 2. MAPA DE BOXES (MEIO) */
        .map-section {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 40px;
        }

        .legend {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;
            margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
        }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--text-light); }
        .legend-color { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }

        .shelves-container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px; /* Aumentado o espa√ßo entre estantes */
            justify-content: center;
        }

        .shelf {
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .shelf:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); z-index: 5; border-color: var(--primary-color); }

        .shelf-header {
            text-align: center; font-size: 12px; font-weight: 700; color: var(--text-light);
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
        }

        .shelf-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px; /* Gap um pouco maior */
        }

        /* Box (Representa√ß√£o do Espa√ßo) */
        .box {
            width: 36px; height: 36px; 
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            cursor: pointer;
            border-radius: 4px;
            
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px; 
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }
        .box:hover {
            transform: scale(1.3);
            z-index: 10;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            color: var(--secondary-color);
        }

        /* 3. ESTAT√çSTICAS DE SITUA√á√ÉO (FUNDO) */
        .status-section { margin-top: 20px; }
        
        .section-title {
            font-size: 22px; font-weight: 700; color: var(--secondary-color);
            margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color); display: inline-block;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .status-card {
            background: var(--bg-white); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 20px;
            display: flex; flex-direction: column; 
            transition: all 0.2s;
        }
        .status-card:hover { box-shadow: var(--shadow-subtle); }

        .status-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; font-weight: 600; color: var(--text-light); }
        .status-val { font-size: 20px; font-weight: 800; color: var(--secondary-color); }
        .progress-bg { height: 8px; background: var(--bg-light); border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        /* Bot√µes de A√ß√£o */
        .action-bar {
            margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border-color);
            text-align: center; display: flex; justify-content: center; gap: 15px;
        }
        .btn-action {
            padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none;
            display: flex; align-items: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-print { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: 0 4px 10px rgba(247, 147, 30, 0.3); 
        }
        .btn-print:hover { background: var(--primary-dark); }
        
        .btn-reset { 
            background: var(--border-color); 
            color: var(--text-light); 
        }

        /* Tooltip (Dark Mode discreto) */
        .tooltip {
            position: fixed; display: none; z-index: 1000;
            background: var(--secondary-color); 
            color: white; padding: 15px; border-radius: 8px;
            font-size: 13px; pointer-events: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 200px;
        }
        .tooltip-header { 
            border-bottom: 1px solid rgba(255,255,255,0.2); 
            padding-bottom: 8px; margin-bottom: 8px; 
            font-weight: 700; font-size: 15px; color: #fff;
            display: flex; justify-content: space-between;
        }
        .tooltip-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .tt-pct { color: var(--primary-color); font-size: 11px; margin-left: 5px; }
        .tt-label { color: #bdbdbd; }

        /* Loading */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--border-color);
            border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;
        }
        
        /* Anima√ß√µes e Responsividade */
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .content { padding: 20px; }
            .header h1 { font-size: 24px; }
            .stats-bar { grid-template-columns: 1fr 1fr; }
            .section-title { font-size: 18px; }
            .status-grid { grid-template-columns: 1fr; }
            .action-bar { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px; color: var(--primary-color);">Mapeando 7.000 Boxes...</h3>
    </div>

    <div class="container">
        <header class="header">
            <h1><i class="fas fa-th"></i> Visualizador de Boxes</h1>
            <p>Mapeamento F√≠sico e Ocupacional do Arquivo em tempo real.</p>
        </header>

        <div class="content">
            <div id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3>Importar Mapa de Boxes</h3>
                    <p style="color:var(--text-light); margin-bottom:15px; font-size:14px;">Arraste o arquivo Excel exportado pelo SGA ou clique para selecionar.</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" hidden>
                    <button class="btn-action btn-print" style="background:var(--primary-color); margin:0 auto;" onclick="document.getElementById('fileInput').click()">
                        Selecionar Arquivo
                    </button>
                </div>
            </div>

            <div id="results">
                
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--secondary-color)">7.000</div>
                        <div class="stat-sub">100%</div>
                        <div class="stat-label">Capacidade Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="valOcupados">0</div>
                        <div class="stat-sub" id="pctOcupados">0%</div>
                        <div class="stat-label">Boxes Ocupados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="valVazios">0</div>
                        <div class="stat-sub" id="pctVazios">0%</div>
                        <div class="stat-label">Boxes Livres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="valDocs">0</div>
                        <div class="stat-sub">unidades</div>
                        <div class="stat-label">Total Documentos</div>
                    </div>
                </div>

                <div class="map-section">
                    <div class="legend" id="legendContainer"></div>
                    <div class="shelves-container" id="shelvesContainer"></div>
                </div>

                <div class="status-section">
                    <div class="section-title">üìë Detalhamento por Situa√ß√£o Documental</div>
                    <div class="status-grid" id="statusGridContainer">
                        </div>
                </div>

                <div class="action-bar">
                    <button class="btn-action btn-reset" onclick="location.reload()">
                        <i class="fas fa-undo"></i> Carregar Novo
                    </button>
                    <button class="btn-action btn-print" onclick="gerarRelatorio()">
                        <i class="fas fa-file-pdf"></i> Gerar Relat√≥rio de Ocupa√ß√£o
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // *** FUN√á√ïES JAVASCRIPT N√ÉO ALTERADAS (MANUTEN√á√ÉO DA FUNCIONALIDADE) ***
        // Para manter a funcionalidade do script intacta, apenas as refer√™ncias de cor
        // dentro das fun√ß√µes de relat√≥rio PDF foram atualizadas.

        // Dados globais para o relat√≥rio
        let relatorioDados = null;

        // --- UPLOAD ---
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', (e) => {
             // Evita que o clique do bot√£o acione a √°rea de upload duas vezes
             if (e.target.closest('.btn-action')) return;
             fileInput.click();
        });
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.background = '#fffbf5'; uploadArea.style.borderColor = 'var(--primary-color)'; });
        uploadArea.addEventListener('dragleave', () => { uploadArea.style.background = 'var(--bg-white)'; uploadArea.style.borderColor = 'var(--border-color)'; });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            if(e.dataTransfer.files.length) processarArquivo(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length) processarArquivo(e.target.files[0]);
        });

        function processarArquivo(file) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('uploadSection').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1});

                    const headers = json[2]; // Linha 3
                    const rows = json.slice(3);
                    
                    const dados = analisarDados(headers, rows);
                    relatorioDados = dados; // Salva para o relat√≥rio
                    
                    setTimeout(() => {
                        renderizar(dados);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('results').style.display = 'block';
                    }, 500);

                } catch (err) {
                    alert('Erro ao ler arquivo. Verifique se o formato do Excel est√° correto.');
                    console.error(err);
                    location.reload();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function analisarDados(headers, rows) {
            const statusCols = headers.map((h, i) => ({name: h, index: i}))
                                      .filter(c => c.name && !['BOX','TOTAL','Total','Box'].includes(c.name));
            
            const boxes = new Array(7001).fill(null);
            let totalOcupados = 0;
            let totalDocs = 0;
            const statusTotals = {};
            statusCols.forEach(c => statusTotals[c.name] = 0);

            rows.forEach(row => {
                const boxNum = parseInt(row[0]);
                if(boxNum > 0 && boxNum <= 7000) {
                    const boxData = { id: boxNum, total: 0, content: {} };
                    statusCols.forEach(col => {
                        const val = parseInt(row[col.index]) || 0;
                        if(val > 0) {
                            boxData.content[col.name] = val;
                            boxData.total += val;
                            statusTotals[col.name] += val;
                        }
                    });
                    if(boxData.total > 0) {
                        boxes[boxNum] = boxData;
                        totalOcupados++;
                        totalDocs += boxData.total;
                    }
                }
            });

            return { boxes, statusCols, statusTotals, totalOcupados, totalDocs };
        }

        // --- RENDERIZA√á√ÉO ---
        function renderizar(dados) {
            const totalBoxes = 7000;
            
            // 1. KPIs
            document.getElementById('valOcupados').innerText = dados.totalOcupados.toLocaleString();
            document.getElementById('pctOcupados').innerText = ((dados.totalOcupados / totalBoxes) * 100).toFixed(1) + '%';
            document.getElementById('valVazios').innerText = (totalBoxes - dados.totalOcupados).toLocaleString();
            document.getElementById('pctVazios').innerText = (((totalBoxes - dados.totalOcupados) / totalBoxes) * 100).toFixed(1) + '%';
            document.getElementById('valDocs').innerText = dados.totalDocs.toLocaleString();

            // 2. Cores e Legenda
            const cores = gerarPaleta(dados.statusCols.length);
            const corMap = {};
            dados.statusCols.forEach((c, i) => corMap[c.name] = cores[i]);

            const legendHtml = dados.statusCols.map(c => `
                <div class="legend-item">
                    <div class="legend-color" style="background:${corMap[c.name]}"></div>${c.name}
                </div>
            `).join('') + `<div class="legend-item"><div class="legend-color" style="background:var(--bg-white); border:1px dashed var(--border-color)"></div>Livre</div>`;
            document.getElementById('legendContainer').innerHTML = legendHtml;

            // 3. Mapa de Boxes (Estantes)
            const container = document.getElementById('shelvesContainer');
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();
            const boxesPorEstante = 49;
            const totalEstantes = Math.ceil(totalBoxes / boxesPorEstante);

            for(let i=0; i<totalEstantes; i++) {
                const start = i * boxesPorEstante + 1;
                const end = Math.min((i+1) * boxesPorEstante, totalBoxes);
                const shelf = document.createElement('div');
                shelf.className = 'shelf';
                shelf.innerHTML = `<div class="shelf-header">${start} - ${end}</div>`;
                const grid = document.createElement('div');
                grid.className = 'shelf-grid';

                for(let b=start; b<=end; b++) {
                    const boxDiv = document.createElement('div');
                    boxDiv.className = 'box';
                    boxDiv.innerText = b; 
                    const boxData = dados.boxes[b];

                    if(boxData) {
                        boxDiv.style.background = gerarGradiente(boxData, corMap);
                        boxDiv.style.color = '#333'; // For√ßa a cor do texto para ser leg√≠vel no gradiente
                        boxDiv.onmouseenter = (e) => showTooltip(e, boxData);
                    } else {
                         // Box Vazio
                        boxDiv.style.background = 'var(--bg-light)';
                        boxDiv.style.color = 'var(--text-light)';
                        boxDiv.onmouseenter = (e) => showTooltip(e, {id: b, total: 0});
                    }
                    boxDiv.onmouseleave = hideTooltip;
                    grid.appendChild(boxDiv);
                }
                shelf.appendChild(grid);
                fragment.appendChild(shelf);
            }
            container.appendChild(fragment);

            // 4. Detalhamento por Situa√ß√£o (Cards no Fundo)
            const statusGrid = document.getElementById('statusGridContainer');
            const sortedStatus = Object.entries(dados.statusTotals).sort((a,b) => b[1] - a[1]);
            
            let statusHtml = '';
            sortedStatus.forEach(([name, count]) => {
                if(count > 0) {
                    const pct = ((count / dados.totalDocs) * 100).toFixed(1);
                    const color = corMap[name];
                    statusHtml += `
                        <div class="status-card" style="border-left: 4px solid ${color}">
                            <div class="status-header">
                                <span>${name}</span>
                                <span style="color:var(--text-light);">${pct}%</span>
                            </div>
                            <div class="status-val">${count.toLocaleString()}</div>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width:${pct}%; background:${color}"></div>
                            </div>
                        </div>
                    `;
                }
            });
            statusGrid.innerHTML = statusHtml;
        }

        // --- RELAT√ìRIO PDF (Estilos atualizados para cores neutras) ---
        function gerarRelatorio() {
            if(!relatorioDados) return;
            
            const totalBoxes = 7000;
            const pctOcup = ((relatorioDados.totalOcupados / totalBoxes) * 100).toFixed(1);
            const pctVaz = (((totalBoxes - relatorioDados.totalOcupados) / totalBoxes) * 100).toFixed(1);
            const sortedStatus = Object.entries(relatorioDados.statusTotals).sort((a,b) => b[1] - a[1]);

            // Gera linhas da tabela
            let rowsHtml = '';
            sortedStatus.forEach(([name, count]) => {
                if(count > 0) {
                    const pct = ((count / relatorioDados.totalDocs) * 100).toFixed(1);
                    rowsHtml += `
                        <tr>
                            <td style="padding:10px; border-bottom:1px solid #ddd;">${name}</td>
                            <td style="padding:10px; border-bottom:1px solid #ddd; text-align:right;">${count.toLocaleString()}</td>
                            <td style="padding:10px; border-bottom:1px solid #ddd; text-align:right;">${pct}%</td>
                        </tr>
                    `;
                }
            });

            const win = window.open('', '', 'width=900,height=700');
            win.document.write(`
                <html>
                <head>
                    <title>Relat√≥rio de Ocupa√ß√£o F√≠sica</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 40px; color: #333; }
                        h1 { text-align: center; color: #1e293b; border-bottom: 2px solid #f7931e; padding-bottom: 20px; }
                        h3 { color: #1e293b; margin-top: 30px; }
                        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 40px; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
                        .kpi { text-align: center; width: 30%; }
                        .kpi-val { font-size: 24px; font-weight: bold; display: block; color: #f7931e; }
                        .kpi-lbl { font-size: 12px; text-transform: uppercase; color: #6b7280; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
                        th { background: #1f2937; color: white; padding: 12px; text-align: left; }
                        .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <h1>Relat√≥rio de Ocupa√ß√£o do Arquivo</h1>
                    
                    <div class="kpi-row">
                        <div class="kpi"><span class="kpi-val">${relatorioDados.totalOcupados.toLocaleString()}</span><span class="kpi-lbl">Boxes Ocupados (${pctOcup}%)</span></div>
                        <div class="kpi"><span class="kpi-val">${(totalBoxes - relatorioDados.totalOcupados).toLocaleString()}</span><span class="kpi-lbl">Boxes Livres (${pctVaz}%)</span></div>
                        <div class="kpi"><span class="kpi-val">${relatorioDados.totalDocs.toLocaleString()}</span><span class="kpi-lbl">Total Documentos</span></div>
                    </div>

                    <h3>Detalhamento por Situa√ß√£o Documental</h3>
                    <table>
                        <thead><tr><th>Situa√ß√£o</th><th style="text-align:right">Quantidade</th><th style="text-align:right">% Total</th></tr></thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>

                    <div class="footer">Gerado automaticamente pelo Sistema de Gest√£o Documental em ${new Date().toLocaleString()}</div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            win.document.close();
        }

        // --- AUXILIARES (N√£o alteradas) ---
        function gerarPaleta(n) {
            const cores = [];
            const step = 360 / n;
            for(let i=0; i<n; i++) cores.push(`hsl(${Math.floor(i*step)}, 70%, 60%)`);
            return cores;
        }

        function gerarGradiente(box, corMap) {
            const entries = Object.entries(box.content);
            if(entries.length === 1) return corMap[entries[0][0]];
            let stops = [], acc = 0;
            entries.forEach(([status, qtd]) => {
                const pct = (qtd / box.total) * 100;
                const color = corMap[status];
                stops.push(`${color} ${acc}%`);
                acc += pct;
                stops.push(`${color} ${acc}%`);
            });
            return `linear-gradient(135deg, ${stops.join(', ')})`;
        }

        // --- TOOLTIP (N√£o alterada) ---
        const tooltip = document.getElementById('tooltip');
        function showTooltip(e, data) {
            let html = `<div class="tooltip-header"><span>üì¶ Box ${data.id}</span></div>`;
            if(data.total > 0) {
                html += `<div class="tooltip-row" style="border-bottom:1px dashed #ffffff44; padding-bottom:5px;"><span>Total:</span> <strong>${data.total}</strong></div>`;
                for(const [st, qtd] of Object.entries(data.content)) {
                    const pct = ((qtd/data.total)*100).toFixed(0);
                    html += `<div class="tooltip-row"><span class="tt-label">${st}:</span><span>${qtd} <span class="tt-pct">(${pct}%)</span></span></div>`;
                }
            } else {
                html += `<div style="text-align:center; color:var(--text-light); font-style:italic;">Livre</div>`;
            }
            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
            moveTooltip(e);
        }
        function moveTooltip(e) {
            const w = tooltip.offsetWidth, h = tooltip.offsetHeight, m = 15;
            let l = e.clientX + m, t = e.clientY + m;
            if(l + w > window.innerWidth) l = e.clientX - w - m;
            if(t + h > window.innerHeight) t = e.clientY - h - m;
            tooltip.style.left = l+'px'; tooltip.style.top = t+'px';
        }
        function hideTooltip() { tooltip.style.display = 'none'; }
        document.addEventListener('mousemove', (e) => { if(tooltip.style.display==='block') moveTooltip(e); });

    </script>
</body>
</html>
