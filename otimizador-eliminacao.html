<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Eliminação Pro | Hub de Serviços</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- VARIÁVEIS E CORES (Identidade Visual Nova) --- */
        :root {
            --primary: #f7931e;        /* Laranja Principal */
            --primary-light: #fff7ed;
            --primary-dark: #d67d12;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 20px;
            min-height: 100vh;
            line-height: 1.5;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        .app-header {
            padding: 25px 40px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; background: #fff;
        }
        .header-title h1 { font-size: 24px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }
        .header-title h1 i { color: var(--primary); margin-right: 10px; }
        .header-desc { font-size: 14px; color: var(--text-sub); margin-top: 4px; }

        .app-content { padding: 40px; }

        /* --- UPLOAD SECTION (DUPLO) --- */
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        
        .upload-card {
            border: 2px dashed var(--border); border-radius: 12px;
            padding: 30px; text-align: center; background: #f9fafb;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .upload-card:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); }
        .upload-card.loaded { border-color: var(--success); background: #ecfdf5; }
        
        .upload-icon { font-size: 32px; color: var(--text-sub); margin-bottom: 15px; transition: color 0.3s; }
        .upload-card:hover .upload-icon { color: var(--primary); }
        .upload-card.loaded .upload-icon { color: var(--success); }
        
        .step-badge {
            position: absolute; top: -12px; left: 20px; background: var(--text-main); color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- CONFIGURAÇÃO (Restaurada do V2) --- */
        .config-panel {
            background: white; border: 1px solid var(--border); border-radius: 12px; padding: 30px;
            margin-bottom: 40px; box-shadow: var(--shadow-md);
        }
        
        .config-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* Cards de Objetivo */
        .objective-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        
        .obj-card {
            border: 2px solid var(--border); border-radius: 10px; padding: 20px;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 15px;
        }
        .obj-card:hover { border-color: var(--primary); background: var(--primary-light); }
        .obj-card.active { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 2px rgba(247, 147, 30, 0.2); }
        
        .obj-icon { font-size: 24px; color: var(--text-sub); }
        .obj-card.active .obj-icon { color: var(--primary); }
        
        /* Inputs de Restrição */
        .constraints-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-items: end; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 15px; font-family: 'Inter', sans-serif; transition: border 0.2s;
        }
        .form-control:focus { border-color: var(--primary); }

        /* --- BOTÃO DE AÇÃO --- */
        .btn {
            padding: 14px 28px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; width: 100%; height: 48px; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); font-size: 14px; padding: 10px 20px; }
        .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }

        /* --- RESULTADOS --- */
        .results-section { display: none; animation: fadeIn 0.5s ease; }
        
        .kpi-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-box { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: var(--shadow-sm); }
        .kpi-val { font-size: 28px; font-weight: 800; color: var(--text-main); line-height: 1.2; }
        .kpi-lbl { font-size: 12px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-top: 5px; }

        /* Blocos */
        .blocks-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        
        .block-unit {
            background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
            transition: all 0.2s; display: flex; flex-direction: column;
        }
        .block-unit:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: var(--shadow-md); }
        
        .block-head {
            background: #f8fafc; padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .block-title { font-weight: 700; color: var(--text-main); font-size: 15px; }
        .block-badge { background: var(--primary-light); color: var(--primary-dark); padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        
        .block-content { padding: 20px; flex: 1; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--text-sub); }
        .stat-val { font-weight: 600; color: var(--text-main); }
        
        .box-list {
            margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border);
            font-family: monospace; font-size: 12px; color: var(--text-sub); line-height: 1.6;
            max-height: 100px; overflow-y: auto;
        }

        /* Log de Erros */
        .error-log {
            margin-top: 40px; background: #fff1f2; border: 1px solid #fecaca; border-radius: 12px; padding: 25px;
            display: none;
        }
        .error-log h4 { color: #991b1b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .error-list { max-height: 200px; overflow-y: auto; padding-left: 20px; font-size: 13px; color: #7f1d1d; }
        .error-list li { margin-bottom: 5px; }

        /* Loading */
        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95);
            display:none; flex-direction:column; justify-content:center; align-items:center; z-index: 50;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="header-title">
                <h1><i class="fas fa-cubes"></i> Otimizador de Eliminação Pro</h1>
                <p class="header-desc">Cross-Check e Agrupamento Inteligente de Boxes</p>
            </div>
            <button class="btn-secondary" onclick="location.reload()" title="Reiniciar"><i class="fas fa-undo"></i></button>
        </header>

        <div class="app-content" style="position: relative;">
            
            <div class="loading-overlay" id="loading">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: var(--primary); margin-bottom: 20px;"></i>
                <h3 style="color: var(--text-main);">Processando Algoritmo...</h3>
                <p style="color: var(--text-sub);">Validando totais e gerando blocos otimizados.</p>
            </div>

            <div id="setupView">
                
                <div class="upload-section">
                    <div class="upload-card" id="dropEliminaveis" onclick="document.getElementById('fileEliminaveis').click()">
                        <span class="step-badge">Passo 1</span>
                        <input type="file" id="fileEliminaveis" accept=".xlsx, .xls, .csv" hidden>
                        <i class="fas fa-file-alt upload-icon" id="iconEliminaveis"></i>
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 5px;">Relatório de Elimináveis</h3>
                        <p style="font-size: 13px; color: var(--text-sub);">Contém os documentos a eliminar (Box na Col K)</p>
                        <div id="nameEliminaveis" style="margin-top:10px; font-weight:600; color:var(--primary); font-size:12px;"></div>
                    </div>

                    <div class="upload-card" id="dropTotais" onclick="document.getElementById('fileTotais').click()">
                        <span class="step-badge">Passo 2</span>
                        <input type="file" id="fileTotais" accept=".xlsx, .xls, .csv" hidden>
                        <i class="fas fa-chart-pie upload-icon" id="iconTotais"></i>
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 5px;">Totais por Box</h3>
                        <p style="font-size: 13px; color: var(--text-sub);">Validação de integridade (Box na Col A, Total na Col I)</p>
                        <div id="nameTotais" style="margin-top:10px; font-weight:600; color:var(--primary); font-size:12px;"></div>
                    </div>
                </div>

                <div class="config-panel">
                    <h3 class="config-title"><i class="fas fa-sliders-h"></i> Parâmetros de Otimização</h3>
                    
                    <label style="font-size:13px; font-weight:600; color:var(--text-sub); margin-bottom:10px; display:block;">Objetivo do Agrupamento:</label>
                    <div class="objective-grid">
                        <div class="obj-card active" id="objDocs" onclick="setObjective('docs')">
                            <i class="fas fa-file-alt obj-icon"></i>
                            <div>
                                <div style="font-weight:700;">Maximizar Documentos</div>
                                <div style="font-size:12px; color:var(--text-sub);">Prioriza boxes mais cheios nos primeiros blocos.</div>
                            </div>
                        </div>
                        <div class="obj-card" id="objBoxes" onclick="setObjective('boxes')">
                            <i class="fas fa-box obj-icon"></i>
                            <div>
                                <div style="font-weight:700;">Distribuir Boxes</div>
                                <div style="font-size:12px; color:var(--text-sub);">Tenta equilibrar a quantidade de boxes.</div>
                            </div>
                        </div>
                    </div>

                    <div class="constraints-grid">
                        <div class="form-group">
                            <label>Máximo de Boxes por Bloco</label>
                            <input type="number" id="maxBoxes" class="form-control" value="20">
                        </div>
                        <div class="form-group">
                            <label>Máximo de Docs por Bloco</label>
                            <input type="number" id="maxDocs" class="form-control" value="2000" placeholder="Opcional">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="btnProcessar" onclick="executarOtimizacao()" disabled>
                                Processar e Gerar Blocos <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="resultsView" class="results-section">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="font-size:20px; font-weight:700;">Resultado da Otimização</h2>
                    <button class="btn btn-primary" onclick="exportarExcel()" style="width: auto; height: 40px; font-size: 14px;">
                        <i class="fas fa-download"></i> Baixar Relatório
                    </button>
                </div>

                <div class="kpi-container">
                    <div class="kpi-box">
                        <div class="kpi-val" id="kpiTotal" style="color:var(--text-main)">0</div>
                        <div class="kpi-lbl">Boxes Analisados</div>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-val" id="kpiValid" style="color:var(--success)">0</div>
                        <div class="kpi-lbl">Aprovados (100% Elim)</div>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-val" id="kpiRejected" style="color:var(--danger)">0</div>
                        <div class="kpi-lbl">Rejeitados (Mistos)</div>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-val" id="kpiBlocks" style="color:var(--primary)">0</div>
                        <div class="kpi-lbl">Blocos Gerados</div>
                    </div>
                </div>

                <div class="blocks-container" id="blocksWrapper">
                    </div>

                <div class="error-log" id="errorLog">
                    <h4><i class="fas fa-exclamation-circle"></i> Boxes Impedidos de Eliminação</h4>
                    <p style="font-size:13px; margin-bottom:10px;">Os seguintes boxes possuem documentos permanentes ou prazos vigentes (Qtd Eliminável ≠ Total Real):</p>
                    <ul class="error-list" id="errorList"></ul>
                </div>

            </div>

        </div>
    </div>

    <script>
        // --- GESTÃO DE ESTADO ---
        let state = {
            fileElim: null,
            fileTot: null,
            objective: 'docs', // 'docs' ou 'boxes'
            finalBlocks: []
        };

        // --- UI INTERACTION ---
        function setObjective(obj) {
            state.objective = obj;
            document.querySelectorAll('.obj-card').forEach(el => el.classList.remove('active'));
            document.getElementById(obj === 'docs' ? 'objDocs' : 'objBoxes').classList.add('active');
        }

        // --- UPLOAD HANDLERS ---
        setupUpload('fileEliminaveis', 'dropEliminaveis', 'nameEliminaveis', 'fileElim');
        setupUpload('fileTotais', 'dropTotais', 'nameTotais', 'fileTot');

        function setupUpload(inputId, dropId, nameId, stateKey) {
            const input = document.getElementById(inputId);
            const drop = document.getElementById(dropId);
            
            input.addEventListener('change', (e) => processFile(e.target.files[0], drop, nameId, stateKey));
            drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.style.borderColor = 'var(--primary)'; });
            drop.addEventListener('dragleave', () => { drop.style.borderColor = 'var(--border)'; });
            drop.addEventListener('drop', (e) => { 
                e.preventDefault(); 
                processFile(e.dataTransfer.files[0], drop, nameId, stateKey); 
            });
        }

        function processFile(file, dropEl, nameEl, stateKey) {
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                // Lê cru (array de arrays)
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                
                state[stateKey] = json;
                
                // UI Feedback
                dropEl.classList.add('loaded');
                document.getElementById(nameEl).innerText = file.name;
                
                // Habilita botão se ambos carregados
                if(state.fileElim && state.fileTot) {
                    document.getElementById('btnProcessar').disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- LÓGICA CORE (Algoritmo + Validação) ---
        function executarOtimizacao() {
            document.getElementById('loading').style.display = 'flex';

            // Timeout para não travar UI
            setTimeout(() => {
                try {
                    // 1. Extração de Dados (Com as regras de coluna específicas)
                    const eliminaveisMap = extrairEliminaveis(state.fileElim);
                    const totaisMap = extrairTotais(state.fileTot);

                    // 2. Cross-Check (Validação)
                    const validos = [];
                    const rejeitados = [];

                    for(const [box, qtdElim] of Object.entries(eliminaveisMap)) {
                        const qtdTotal = totaisMap[box];
                        
                        if(qtdTotal === undefined) {
                            rejeitados.push({ id: box, motivo: 'Não encontrado na planilha de Totais' });
                        } else if(qtdElim === qtdTotal) {
                            validos.push({ id: box, qtd: qtdElim });
                        } else {
                            rejeitados.push({ id: box, motivo: `Divergência: ${qtdElim} elim. / ${qtdTotal} total` });
                        }
                    }

                    // 3. Otimização (Bin Packing)
                    const maxBoxes = parseInt(document.getElementById('maxBoxes').value) || 20;
                    const maxDocs = parseInt(document.getElementById('maxDocs').value) || 999999;
                    
                    const blocos = rodarBinPacking(validos, maxBoxes, maxDocs, state.objective);
                    state.finalBlocks = blocos;

                    // 4. Renderização
                    renderizarResultados(Object.keys(eliminaveisMap).length, validos.length, rejeitados, blocos);

                } catch (e) {
                    alert('Erro no processamento: ' + e.message);
                    console.error(e);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('setupView').style.display = 'none';
                    document.getElementById('resultsView').style.display = 'block';
                }
            }, 500);
        }

        // --- EXTRAÇÃO (Regras do Usuário) ---
        function extrairEliminaveis(rows) {
            const map = {};
            // Coluna K = índice 10. Linha 2 = índice 1.
            for(let i=1; i<rows.length; i++) {
                const row = rows[i];
                if(row && row[10] !== undefined) {
                    const box = String(row[10]).trim();
                    if(box) map[box] = (map[box] || 0) + 1;
                }
            }
            return map;
        }

        function extrairTotais(rows) {
            const map = {};
            // Coluna A = 0. Coluna I = 8. Linha 4 = índice 3.
            for(let i=3; i<rows.length; i++) {
                const row = rows[i];
                if(row) {
                    const box = row[0];
                    const total = row[8];
                    if(box !== undefined && total !== undefined) {
                        // Limpeza robusta (remove .0 de floats convertidos)
                        const key = String(box).trim().replace(/\.0$/, '');
                        map[key] = parseInt(total);
                    }
                }
            }
            return map;
        }

        // --- ALGORITMO DE OTIMIZAÇÃO (Best Fit Decreasing) ---
        function rodarBinPacking(items, capBox, capDocs, criterio) {
            // Ordenação Estratégica
            // Se o objetivo é 'docs': Começa pelos boxes mais cheios para encher o bloco rápido
            // Se o objetivo é 'boxes': Também é melhor começar pelos cheios para encaixar os pequenos depois (Best Fit)
            items.sort((a,b) => b.qtd - a.qtd);

            const blocos = [];

            items.forEach(item => {
                // Tenta encontrar o "Melhor Bloco" existente (aquele que cabe e sobra menos espaço)
                let bestBlock = null;
                let minSpaceLeft = Infinity;

                for(const bloco of blocos) {
                    const currentBoxes = bloco.items.length;
                    const currentDocs = bloco.totalDocs;

                    if(currentBoxes < capBox && (currentDocs + item.qtd) <= capDocs) {
                        const spaceLeft = (capDocs - (currentDocs + item.qtd)); // Heurística baseada em Docs
                        if(spaceLeft < minSpaceLeft) {
                            minSpaceLeft = spaceLeft;
                            bestBlock = bloco;
                        }
                    }
                }

                if(bestBlock) {
                    bestBlock.items.push(item);
                    bestBlock.totalDocs += item.qtd;
                } else {
                    // Cria novo bloco
                    blocos.push({
                        id: blocos.length + 1,
                        items: [item],
                        totalDocs: item.qtd
                    });
                }
            });

            return blocos;
        }

        // --- RENDERIZAÇÃO ---
        function renderizarResultados(total, valid, rejected, blocks) {
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiValid').innerText = valid;
            document.getElementById('kpiRejected').innerText = rejected.length;
            document.getElementById('kpiBlocks').innerText = blocks.length;

            // Render Blocos
            const container = document.getElementById('blocksWrapper');
            container.innerHTML = '';
            
            blocks.forEach(bloco => {
                const boxesStr = bloco.items.map(b => b.id).join(', ');
                const html = `
                    <div class="block-unit">
                        <div class="block-head">
                            <span class="block-title"><i class="fas fa-cube" style="color:var(--primary)"></i> Bloco #${bloco.id}</span>
                            <span class="block-badge">${bloco.items.length} Boxes</span>
                        </div>
                        <div class="block-content">
                            <div class="stat-row">
                                <span>Total Docs:</span>
                                <span class="stat-val">${bloco.totalDocs}</span>
                            </div>
                            <div class="stat-row">
                                <span>Densidade Média:</span>
                                <span class="stat-val">${(bloco.totalDocs / bloco.items.length).toFixed(1)}</span>
                            </div>
                            <div class="box-list" title="${boxesStr}">${boxesStr}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            // Render Erros
            const errorLog = document.getElementById('errorLog');
            const errorList = document.getElementById('errorList');
            if(rejected.length > 0) {
                errorLog.style.display = 'block';
                errorList.innerHTML = rejected.map(r => `<li><strong>Box ${r.id}:</strong> ${r.motivo}</li>`).join('');
            } else {
                errorLog.style.display = 'none';
            }
        }

        // --- EXPORTAR ---
        function exportarExcel() {
            if(!state.finalBlocks.length) return;
            
            const wb = XLSX.utils.book_new();
            const data = [];
            
            state.finalBlocks.forEach(bloco => {
                bloco.items.forEach(box => {
                    data.push({
                        'Bloco': bloco.id,
                        'Box': box.id,
                        'Qtd Documentos': box.qtd
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Otimização");
            XLSX.writeFile(wb, "Blocos_Eliminacao.xlsx");
        }
    </script>
</body>
</html>
